{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="https://js.arcgis.com/next/esri/themes/light/main.css">
<script src="https://js.arcgis.com/next/"></script>
{% endblock head %}

{% block content %}
    <div id="left_mapview_container" style="width: 50vw; height: 100vw; position: absolute; left: 0">{{ pair.old_image }}</div>
    <div id="right_mapview_container" style="width: 50vw; height: 100vw; position: absolute; right: 0">{{ pair.new_image }}</div>
    <script type="text/javascript">

    const setupSideBySide = ()=>{
        require(["esri/Map",
            "esri/views/MapView",
            "esri/layers/ImageryTileLayer",
            "esri/views/draw/Draw",
            "esri/layers/GraphicsLayer",
            "esri/widgets/Sketch"
        ], function (
                Map, MapView, ImageryTileLayer, Draw, GraphicsLayer, Sketch){
            const makeTileMap = (tile_url, container)=>{
                const webmap = new Map({});
                const locog = new ImageryTileLayer({
                    url: tile_url,
                })
                webmap.layers.add(locog);
                return new MapView({
                    container: container,
                    map: webmap,
                    constraints: {
                        snapToZoom: false
                    }
                })
            }

            const leftview = makeTileMap('{{ pair.old_image.file_data.url }}', 'left_mapview_container')
            const rightview = makeTileMap('{{ pair.new_image.file_data.url }}', 'right_mapview_container')
            const views = [leftview, rightview]
            console.log(views)
            let active = leftview


            // TODO move this function into a utils file
            const sync = (source) => {
                // Sets the center and zoom of all views to the center and zoom of source
                if (!active || !active.viewpoint || active !== source) {
                    return
                }

                for (const view of views) {
                    if (view !== source) {
                        view.viewpoint = source.viewpoint
                    }
                }
            }
            
            for (const view of views) {
                view.watch(["interacting", "animation"], () => {
                    active = view
                    sync(active)
                })

                view.watch("viewpoint", () => sync(view))
            }

            // Drawing stuff
            const annotationLayer = new GraphicsLayer()
            const annotationLayerCopy = new GraphicsLayer()
            console.log('annotation layer')
            console.log(annotationLayer)
            leftview.map.layers.add(annotationLayer)
            rightview.map.layers.add(annotationLayerCopy)
            const sketch = new Sketch({
                layer: annotationLayer,
                view: leftview,
                availableCreateTools: ["polygon"]
            });
            annotationLayer.graphics.on('after-add', (evt) => {
                console.log(evt.item)
                annotationLayerCopy.graphics.add(evt.item.clone())
            })
            leftview.ui.add(sketch, "top-right")
        })
    }
    const urlParams = new URLSearchParams(window.location.search)
    if (urlParams.get('comparer')==='blink') {
        console.log("Blink / fade mode not yet implemented")
    } else {
        // assuming we're in side-by-side mode
        setupSideBySide()
    }
    </script>
{% endblock content %}
